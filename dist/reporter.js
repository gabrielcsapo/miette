"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.Reporter = void 0;
function minimumGuard(count, minimum) {
    if (count < minimum) {
        return minimum;
    }
    return count;
}
class Reporter {
    constructor(diagnostic, style, characters) {
        // This will be used to store the raw output and used in tests for assertions
        this.debugString = "";
        this.diagnostic = diagnostic;
        this.theme = {
            style,
            characters,
        };
    }
    write(str) {
        process.stdout.write(str);
        this.debugString += str;
    }
    writeLine(str) {
        process.stdout.write(str + "\n");
        this.debugString += str + "\n";
    }
    severityStyle() {
        if (this.diagnostic.severity === "WARNING") {
            return this.theme.style.warning;
        }
        if (this.diagnostic.severity === "ADVICE") {
            return this.theme.style.advice;
        }
        return this.theme.style.error;
    }
    getLines(str) {
        let line = 0;
        let column = 0;
        let offset = 0;
        let line_offset = 0;
        let line_str = "";
        const lines = [];
        const iter = str.split("");
        iter.forEach((c, i) => {
            const at_end_of_file = iter.length === i + 1;
            if (c === "\r") {
                if (iter[i + 1] === "\n") {
                    offset += 1;
                    line += 1;
                    column = 0;
                }
                else {
                    line_str += c;
                    column += 1;
                }
            }
            if (c === "\n") {
                line += 1;
                column = 0;
            }
            if (c !== "\n" && c !== "\r") {
                line_str += c;
                column += 1;
            }
            if (c === " ") {
                line_offset += 1;
            }
            if (iter[i + 1] === "" && !at_end_of_file) {
                line += 1;
            }
            if (column === 0 || iter[i + 1] === "") {
                lines.push({
                    line_number: line,
                    offset: line_offset,
                    length: line_str.length - line_offset,
                    text: line_str,
                });
                line_str = "";
                line_offset = offset;
            }
        });
        return lines;
    }
    render() {
        this.render_header();
        this.render_cause();
        this.render_snippets();
        this.render_footer();
    }
    render_header() {
        if (this.diagnostic.url) {
            this.writeLine(`Error: ${this.theme.style.code(`${this.diagnostic.functionName} ( ${this.diagnostic.url} )`)}`);
        }
        else {
            this.writeLine(`Error: ${this.theme.style.code(this.diagnostic.functionName)}`);
        }
    }
    render_cause() {
        const severityStyle = this.severityStyle();
        if (this.diagnostic.error) {
            this.writeLine("");
            this.writeLine(`${" ".repeat(3)}${severityStyle(`${this.theme.characters.x} ${this.diagnostic.message}`)}`);
        }
    }
    render_snippets() {
        this.writeLine("");
        const severityStyle = this.severityStyle();
        const lines = this.getLines(this.diagnostic.source);
        const lineWidth = lines
            .map((line) => line.line_number)
            .sort((a, b) => b - a)[0]
            .toString().length;
        this.write(`${" ".repeat(lineWidth + 2)}${this.theme.characters.ltop}${this.theme.characters.hbar.repeat(3)}`);
        // if we have a name for the snippet we should use that
        this.write(`[${this.diagnostic.fileAndLineNumber}]`);
        this.writeLine("");
        lines.forEach((line, i) => {
            const gutterAndLineNumberOffset = lineWidth;
            this.writeLine(` ${i} ${" ".repeat(minimumGuard(lineWidth - i.toString().length, 0))}${this.theme.characters.vbar} ${line.text}`);
            // get all the snippets that are applicable to a certain line
            const snippetsOnLineSorted = this.diagnostic.snippets
                .filter((snippet) => {
                return line.text.trim().indexOf(snippet.context) > -1;
            })
                .map((snippet, i) => {
                return {
                    ...snippet,
                    rendered: false,
                    offset: line.text.trim().indexOf(snippet.context),
                    color: this.theme.style.highlights[i],
                };
            })
                .sort((a, b) => {
                return a.offset - b.offset;
            });
            // Short circuit and do nothing as there are no snippets
            if (snippetsOnLineSorted.length === 0) {
                return;
            }
            // Render the initial selection bar for the text the snippet is related to
            const initialHighlighedLine = Array(line.length).fill(" ");
            snippetsOnLineSorted.forEach((snippet) => {
                // TODO: colorizing everything is expensive, we should be able to reduce the cost of doing this
                // We are setting the bars and splicing the mtop character in the middle of the needed length at the right offset
                const highlightedBar = Array(snippet.context.length).fill(snippet.color(this.theme.characters.hbar));
                highlightedBar.splice(snippet.context.length / 2, 1, [
                    snippet.color(this.theme.characters.mtop),
                ]);
                initialHighlighedLine.splice(snippet.offset, snippet.context.length, ...highlightedBar);
            });
            // set the line offset that needs to be added when we are only rendering a single entry on a line or multiple
            const lineOffset = snippetsOnLineSorted.length > 1 ? 1 : line.offset + 1;
            // Renders the initially highlights for the line
            this.writeLine(`${" ".repeat(lineWidth + 2)}${this.theme.characters.vbar_break}${" ".repeat(lineOffset)}${initialHighlighedLine.join("")}`);
            // continue looping until we have rendered all the snippets
            while (snippetsOnLineSorted.length > 0) {
                const lineToRender = Array(line.length).fill(" ");
                snippetsOnLineSorted.forEach((snippet, i) => {
                    // If we are the last snippet then we can render out the context
                    if (i === snippetsOnLineSorted.length - 1) {
                        lineToRender.splice(snippet.offset + snippet.context.length / 2, 1, [
                            snippet.color(this.theme.characters.lbot +
                                this.theme.characters.underline.repeat(2) +
                                " " +
                                snippet.highlight),
                        ]);
                        snippetsOnLineSorted.pop();
                    }
                    else {
                        lineToRender.splice(snippet.offset + snippet.context.length / 2, 1, [snippet.color(this.theme.characters.vbar)]);
                    }
                });
                this.writeLine(`${" ".repeat(lineWidth + 2)}${this.theme.characters.vbar_break}${" ".repeat(lineOffset)}${lineToRender.join("")}`);
            }
        });
        this.write(`${" ".repeat(lineWidth + 2)}${this.theme.characters.lbot}${this.theme.characters.hbar.repeat(3)}`);
    }
    render_footer() {
        if (this.diagnostic.help) {
            this.writeLine("");
            this.write(this.theme.characters.fyi + " ");
            this.writeLine(this.theme.style.help(this.diagnostic.help));
        }
        this.writeLine("");
    }
}
exports.Reporter = Reporter;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVwb3J0ZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvcmVwb3J0ZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBV0EsU0FBUyxZQUFZLENBQUMsS0FBYSxFQUFFLE9BQWU7SUFDbEQsSUFBSSxLQUFLLEdBQUcsT0FBTyxFQUFFO1FBQ25CLE9BQU8sT0FBTyxDQUFDO0tBQ2hCO0lBRUQsT0FBTyxLQUFLLENBQUM7QUFDZixDQUFDO0FBQ0QsTUFBYSxRQUFRO0lBV25CLFlBQ0UsVUFBc0IsRUFDdEIsS0FBa0IsRUFDbEIsVUFBNEI7UUFOOUIsNkVBQTZFO1FBQzdFLGdCQUFXLEdBQUcsRUFBRSxDQUFDO1FBT2YsSUFBSSxDQUFDLFVBQVUsR0FBRyxVQUFVLENBQUM7UUFDN0IsSUFBSSxDQUFDLEtBQUssR0FBRztZQUNYLEtBQUs7WUFDTCxVQUFVO1NBQ1gsQ0FBQztJQUNKLENBQUM7SUFFRCxLQUFLLENBQUMsR0FBVztRQUNmLE9BQU8sQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBRTFCLElBQUksQ0FBQyxXQUFXLElBQUksR0FBRyxDQUFDO0lBQzFCLENBQUM7SUFFRCxTQUFTLENBQUMsR0FBVztRQUNuQixPQUFPLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxHQUFHLEdBQUcsSUFBSSxDQUFDLENBQUM7UUFFakMsSUFBSSxDQUFDLFdBQVcsSUFBSSxHQUFHLEdBQUcsSUFBSSxDQUFDO0lBQ2pDLENBQUM7SUFFRCxhQUFhO1FBQ1gsSUFBSSxJQUFJLENBQUMsVUFBVSxDQUFDLFFBQVEsS0FBSyxTQUFTLEVBQUU7WUFDMUMsT0FBTyxJQUFJLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUM7U0FDakM7UUFFRCxJQUFJLElBQUksQ0FBQyxVQUFVLENBQUMsUUFBUSxLQUFLLFFBQVEsRUFBRTtZQUN6QyxPQUFPLElBQUksQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FB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QUFDO1NBQzdEO1FBQ0QsSUFBSSxDQUFDLFNBQVMsQ0FBQyxFQUFFLENBQUMsQ0FBQztJQUNyQixDQUFDO0NBQ0Y7QUEvUUQsNEJBK1FDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ2hhbGsgfSBmcm9tIFwiY2hhbGtcIjtcblxuaW1wb3J0IHsgRGlhZ25vc3RpYyB9IGZyb20gXCIuL2RpYWdub3N0aWNcIjtcbmltcG9ydCB7IElTbmlwcGV0LCBJTGluZSwgSVRoZW1lU3R5bGUsIElUaGVtZUNoYXJhY3RlcnMgfSBmcm9tIFwiLi90eXBlc1wiO1xuXG5pbnRlcmZhY2UgSVNuaXBwZXRSZW5kZXJlZCBleHRlbmRzIElTbmlwcGV0IHtcbiAgb2Zmc2V0OiBudW1iZXI7XG4gIHJlbmRlcmVkPzogYm9vbGVhbjtcbiAgY29sb3I6IENoYWxrO1xufVxuXG5mdW5jdGlvbiBtaW5pbXVtR3VhcmQoY291bnQ6IG51bWJlciwgbWluaW11bTogbnVtYmVyKSB7XG4gIGlmIChjb3VudCA8IG1pbmltdW0pIHtcbiAgICByZXR1cm4gbWluaW11bTtcbiAgfVxuXG4gIHJldHVybiBjb3VudDtcbn1cbmV4cG9ydCBjbGFzcyBSZXBvcnRlciB7XG4gIHRoZW1lOiB7XG4gICAgc3R5bGU6IElUaGVtZVN0eWxlO1xuICAgIGNoYXJhY3RlcnM6IElUaGVtZUNoYXJhY3RlcnM7XG4gIH07XG5cbiAgZGlhZ25vc3RpYzogRGlhZ25vc3RpYztcblxuICAvLyBUaGlzIHdpbGwgYmUgdXNlZCB0byBzdG9yZSB0aGUgcmF3IG91dHB1dCBhbmQgdXNlZCBpbiB0ZXN0cyBmb3IgYXNzZXJ0aW9uc1xuICBkZWJ1Z1N0cmluZyA9IFwiXCI7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgZGlhZ25vc3RpYzogRGlhZ25vc3RpYyxcbiAgICBzdHlsZTogSVRoZW1lU3R5bGUsXG4gICAgY2hhcmFjdGVyczogSVRoZW1lQ2hhcmFjdGVyc1xuICApIHtcbiAgICB0aGlzLmRpYWdub3N0aWMgPSBkaWFnbm9zdGljO1xuICAgIHRoaXMudGhlbWUgPSB7XG4gICAgICBzdHlsZSxcbiAgICAgIGNoYXJhY3RlcnMsXG4gICAgfTtcbiAgfVxuXG4gIHdyaXRlKHN0cjogc3RyaW5nKTogdm9pZCB7XG4gICAgcHJvY2Vzcy5zdGRvdXQud3JpdGUoc3RyKTtcblxuICAgIHRoaXMuZGVidWdTdHJpbmcgKz0gc3RyO1xuICB9XG5cbiAgd3JpdGVMaW5lKHN0cjogc3RyaW5nKTogdm9pZCB7XG4gICAgcHJvY2Vzcy5zdGRvdXQud3JpdGUoc3RyICsgXCJcXG5cIik7XG5cbiAgICB0aGlzLmRlYnVnU3RyaW5nICs9IHN0ciArIFwiXFxuXCI7XG4gIH1cblxuICBzZXZlcml0eVN0eWxlKCk6IENoYWxrIHtcbiAgICBpZiAodGhpcy5kaWFnbm9zdGljLnNldmVyaXR5ID09PSBcIldBUk5JTkdcIikge1xuICAgICAgcmV0dXJuIHRoaXMudGhlbWUuc3R5bGUud2FybmluZztcbiAgICB9XG5cbiAgICBpZiAodGhpcy5kaWFnbm9zdGljLnNldmVyaXR5ID09PSBcIkFEVklDRVwiKSB7XG4gICAgICByZXR1cm4gdGhpcy50aGVtZS5zdHlsZS5hZHZpY2U7XG4gICAgfVxuXG4gICAgcmV0dXJuIHRoaXMudGhlbWUuc3R5bGUuZXJyb3I7XG4gIH1cblxuICBnZXRMaW5lcyhzdHI6IHN0cmluZyk6IElMaW5lW10ge1xuICAgIGxldCBsaW5lID0gMDtcbiAgICBsZXQgY29sdW1uID0gMDtcbiAgICBsZXQgb2Zmc2V0ID0gMDtcbiAgICBsZXQgbGluZV9vZmZzZXQgPSAwO1xuXG4gICAgbGV0IGxpbmVfc3RyID0gXCJcIjtcbiAgICBjb25zdCBsaW5lczogSUxpbmVbXSA9IFtdO1xuXG4gICAgY29uc3QgaXRlciA9IHN0ci5zcGxpdChcIlwiKTtcblxuICAgIGl0ZXIuZm9yRWFjaCgoYywgaSkgPT4ge1xuICAgICAgY29uc3QgYXRfZW5kX29mX2ZpbGUgPSBpdGVyLmxlbmd0aCA9PT0gaSArIDE7XG5cbiAgICAgIGlmIChjID09PSBcIlxcclwiKSB7XG4gICAgICAgIGlmIChpdGVyW2kgKyAxXSA9PT0gXCJcXG5cIikge1xuICAgICAgICAgIG9mZnNldCArPSAxO1xuICAgICAgICAgIGxpbmUgKz0gMTtcbiAgICAgICAgICBjb2x1bW4gPSAwO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGxpbmVfc3RyICs9IGM7XG4gICAgICAgICAgY29sdW1uICs9IDE7XG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgaWYgKGMgPT09IFwiXFxuXCIpIHtcbiAgICAgICAgbGluZSArPSAxO1xuICAgICAgICBjb2x1bW4gPSAwO1xuICAgICAgfVxuXG4gICAgICBpZiAoYyAhPT0gXCJcXG5cIiAmJiBjICE9PSBcIlxcclwiKSB7XG4gICAgICAgIGxpbmVfc3RyICs9IGM7XG4gICAgICAgIGNvbHVtbiArPSAxO1xuICAgICAgfVxuXG4gICAgICBpZiAoYyA9PT0gXCIgXCIpIHtcbiAgICAgICAgbGluZV9vZmZzZXQgKz0gMTtcbiAgICAgIH1cblxuICAgICAgaWYgKGl0ZXJbaSArIDFdID09PSBcIlwiICYmICFhdF9lbmRfb2ZfZmlsZSkge1xuICAgICAgICBsaW5lICs9IDE7XG4gICAgICB9XG5cbiAgICAgIGlmIChjb2x1bW4gPT09IDAgfHwgaXRlcltpICsgMV0gPT09IFwiXCIpIHtcbiAgICAgICAgbGluZXMucHVzaCh7XG4gICAgICAgICAgbGluZV9udW1iZXI6IGxpbmUsXG4gICAgICAgICAgb2Zmc2V0OiBsaW5lX29mZnNldCxcbiAgICAgICAgICBsZW5ndGg6IGxpbmVfc3RyLmxlbmd0aCAtIGxpbmVfb2Zmc2V0LFxuICAgICAgICAgIHRleHQ6IGxpbmVfc3RyLFxuICAgICAgICB9KTtcbiAgICAgICAgbGluZV9zdHIgPSBcIlwiO1xuICAgICAgICBsaW5lX29mZnNldCA9IG9mZnNldDtcbiAgICAgIH1cbiAgICB9KTtcblxuICAgIHJldHVybiBsaW5lcztcbiAgfVxuXG4gIHJlbmRlcigpOiB2b2lkIHtcbiAgICB0aGlzLnJlbmRlcl9oZWFkZXIoKTtcbiAgICB0aGlzLnJlbmRlcl9jYXVzZSgpO1xuICAgIHRoaXMucmVuZGVyX3NuaXBwZXRzKCk7XG4gICAgdGhpcy5yZW5kZXJfZm9vdGVyKCk7XG4gIH1cblxuICByZW5kZXJfaGVhZGVyKCk6IHZvaWQge1xuICAgIGlmICh0aGlzLmRpYWdub3N0aWMudXJsKSB7XG4gICAgICB0aGlzLndyaXRlTGluZShcbiAgICAgICAgYEVycm9yOiAke3RoaXMudGhlbWUuc3R5bGUuY29kZShcbiAgICAgICAgICBgJHt0aGlzLmRpYWdub3N0aWMuZnVuY3Rpb25OYW1lfSAoICR7dGhpcy5kaWFnbm9zdGljLnVybH0gKWBcbiAgICAgICAgKX1gXG4gICAgICApO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLndyaXRlTGluZShcbiAgICAgICAgYEVycm9yOiAke3RoaXMudGhlbWUuc3R5bGUuY29kZSh0aGlzLmRpYWdub3N0aWMuZnVuY3Rpb25OYW1lKX1gXG4gICAgICApO1xuICAgIH1cbiAgfVxuXG4gIHJlbmRlcl9jYXVzZSgpOiB2b2lkIHtcbiAgICBjb25zdCBzZXZlcml0eVN0eWxlID0gdGhpcy5zZXZlcml0eVN0eWxlKCk7XG5cbiAgICBpZiAodGhpcy5kaWFnbm9zdGljLmVycm9yKSB7XG4gICAgICB0aGlzLndyaXRlTGluZShcIlwiKTtcbiAgICAgIHRoaXMud3JpdGVMaW5lKFxuICAgICAgICBgJHtcIiBcIi5yZXBlYXQoMyl9JHtzZXZlcml0eVN0eWxlKFxuICAgICAgICAgIGAke3RoaXMudGhlbWUuY2hhcmFjdGVycy54fSAke3RoaXMuZGlhZ25vc3RpYy5tZXNzYWdlfWBcbiAgICAgICAgKX1gXG4gICAgICApO1xuICAgIH1cbiAgfVxuXG4gIHJlbmRlcl9zbmlwcGV0cygpOiB2b2lkIHtcbiAgICB0aGlzLndyaXRlTGluZShcIlwiKTtcblxuICAgIGNvbnN0IHNldmVyaXR5U3R5bGUgPSB0aGlzLnNldmVyaXR5U3R5bGUoKTtcblxuICAgIGNvbnN0IGxpbmVzID0gdGhpcy5nZXRMaW5lcyh0aGlzLmRpYWdub3N0aWMuc291cmNlKTtcbiAgICBjb25zdCBsaW5lV2lkdGggPSBsaW5lc1xuICAgICAgLm1hcCgobGluZSkgPT4gbGluZS5saW5lX251bWJlcilcbiAgICAgIC5zb3J0KChhLCBiKSA9PiBiIC0gYSlbMF1cbiAgICAgIC50b1N0cmluZygpLmxlbmd0aDtcblxuICAgIHRoaXMud3JpdGUoXG4gICAgICBgJHtcIiBcIi5yZXBlYXQobGluZVdpZHRoICsgMil9JHtcbiAgICAgICAgdGhpcy50aGVtZS5jaGFyYWN0ZXJzLmx0b3BcbiAgICAgIH0ke3RoaXMudGhlbWUuY2hhcmFjdGVycy5oYmFyLnJlcGVhdCgzKX1gXG4gICAgKTtcblxuICAgIC8vIGlmIHdlIGhhdmUgYSBuYW1lIGZvciB0aGUgc25pcHBldCB3ZSBzaG91bGQgdXNlIHRoYXRcbiAgICB0aGlzLndyaXRlKGBbJHt0aGlzLmRpYWdub3N0aWMuZmlsZUFuZExpbmVOdW1iZXJ9XWApO1xuICAgIHRoaXMud3JpdGVMaW5lKFwiXCIpO1xuXG4gICAgbGluZXMuZm9yRWFjaCgobGluZSwgaSkgPT4ge1xuICAgICAgY29uc3QgZ3V0dGVyQW5kTGluZU51bWJlck9mZnNldCA9IGxpbmVXaWR0aDtcblxuICAgICAgdGhpcy53cml0ZUxpbmUoXG4gICAgICAgIGAgJHtpfSAke1wiIFwiLnJlcGVhdChtaW5pbXVtR3VhcmQobGluZVdpZHRoIC0gaS50b1N0cmluZygpLmxlbmd0aCwgMCkpfSR7XG4gICAgICAgICAgdGhpcy50aGVtZS5jaGFyYWN0ZXJzLnZiYXJcbiAgICAgICAgfSAke2xpbmUudGV4dH1gXG4gICAgICApO1xuXG4gICAgICAvLyBnZXQgYWxsIHRoZSBzbmlwcGV0cyB0aGF0IGFyZSBhcHBsaWNhYmxlIHRvIGEgY2VydGFpbiBsaW5lXG4gICAgICBjb25zdCBzbmlwcGV0c09uTGluZVNvcnRlZDogSVNuaXBwZXRSZW5kZXJlZFtdID0gdGhpcy5kaWFnbm9zdGljLnNuaXBwZXRzXG4gICAgICAgIC5maWx0ZXIoKHNuaXBwZXQpID0+IHtcbiAgICAgICAgICByZXR1cm4gbGluZS50ZXh0LnRyaW0oKS5pbmRleE9mKHNuaXBwZXQuY29udGV4dCkgPiAtMTtcbiAgICAgICAgfSlcbiAgICAgICAgLm1hcCgoc25pcHBldCwgaSkgPT4ge1xuICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAuLi5zbmlwcGV0LFxuICAgICAgICAgICAgcmVuZGVyZWQ6IGZhbHNlLFxuICAgICAgICAgICAgb2Zmc2V0OiBsaW5lLnRleHQudHJpbSgpLmluZGV4T2Yoc25pcHBldC5jb250ZXh0KSxcbiAgICAgICAgICAgIGNvbG9yOiB0aGlzLnRoZW1lLnN0eWxlLmhpZ2hsaWdodHNbaV0sXG4gICAgICAgICAgfTtcbiAgICAgICAgfSlcbiAgICAgICAgLnNvcnQoKGEsIGIpID0+IHtcbiAgICAgICAgICByZXR1cm4gYS5vZmZzZXQgLSBiLm9mZnNldDtcbiAgICAgICAgfSk7XG5cbiAgICAgIC8vIFNob3J0IGNpcmN1aXQgYW5kIGRvIG5vdGhpbmcgYXMgdGhlcmUgYXJlIG5vIHNuaXBwZXRzXG4gICAgICBpZiAoc25pcHBldHNPbkxpbmVTb3J0ZWQubGVuZ3RoID09PSAwKSB7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cblxuICAgICAgLy8gUmVuZGVyIHRoZSBpbml0aWFsIHNlbGVjdGlvbiBiYXIgZm9yIHRoZSB0ZXh0IHRoZSBzbmlwcGV0IGlzIHJlbGF0ZWQgdG9cbiAgICAgIGNvbnN0IGluaXRpYWxIaWdobGlnaGVkTGluZSA9IEFycmF5KGxpbmUubGVuZ3RoKS5maWxsKFwiIFwiKTtcbiAgICAgIHNuaXBwZXRzT25MaW5lU29ydGVkLmZvckVhY2goKHNuaXBwZXQpID0+IHtcbiAgICAgICAgLy8gVE9ETzogY29sb3JpemluZyBldmVyeXRoaW5nIGlzIGV4cGVuc2l2ZSwgd2Ugc2hvdWxkIGJlIGFibGUgdG8gcmVkdWNlIHRoZSBjb3N0IG9mIGRvaW5nIHRoaXNcblxuICAgICAgICAvLyBXZSBhcmUgc2V0dGluZyB0aGUgYmFycyBhbmQgc3BsaWNpbmcgdGhlIG10b3AgY2hhcmFjdGVyIGluIHRoZSBtaWRkbGUgb2YgdGhlIG5lZWRlZCBsZW5ndGggYXQgdGhlIHJpZ2h0IG9mZnNldFxuICAgICAgICBjb25zdCBoaWdobGlnaHRlZEJhciA9IEFycmF5KHNuaXBwZXQuY29udGV4dC5sZW5ndGgpLmZpbGwoXG4gICAgICAgICAgc25pcHBldC5jb2xvcih0aGlzLnRoZW1lLmNoYXJhY3RlcnMuaGJhcilcbiAgICAgICAgKTtcbiAgICAgICAgaGlnaGxpZ2h0ZWRCYXIuc3BsaWNlKHNuaXBwZXQuY29udGV4dC5sZW5ndGggLyAyLCAxLCBbXG4gICAgICAgICAgc25pcHBldC5jb2xvcih0aGlzLnRoZW1lLmNoYXJhY3RlcnMubXRvcCksXG4gICAgICAgIF0pO1xuICAgICAgICBpbml0aWFsSGlnaGxpZ2hlZExpbmUuc3BsaWNlKFxuICAgICAgICAgIHNuaXBwZXQub2Zmc2V0LFxuICAgICAgICAgIHNuaXBwZXQuY29udGV4dC5sZW5ndGgsXG4gICAgICAgICAgLi4uaGlnaGxpZ2h0ZWRCYXJcbiAgICAgICAgKTtcbiAgICAgIH0pO1xuXG4gICAgICAvLyBzZXQgdGhlIGxpbmUgb2Zmc2V0IHRoYXQgbmVlZHMgdG8gYmUgYWRkZWQgd2hlbiB3ZSBhcmUgb25seSByZW5kZXJpbmcgYSBzaW5nbGUgZW50cnkgb24gYSBsaW5lIG9yIG11bHRpcGxlXG4gICAgICBjb25zdCBsaW5lT2Zmc2V0ID0gc25pcHBldHNPbkxpbmVTb3J0ZWQubGVuZ3RoID4gMSA/IDEgOiBsaW5lLm9mZnNldCArIDE7XG5cbiAgICAgIC8vIFJlbmRlcnMgdGhlIGluaXRpYWxseSBoaWdobGlnaHRzIGZvciB0aGUgbGluZVxuICAgICAgdGhpcy53cml0ZUxpbmUoXG4gICAgICAgIGAke1wiIFwiLnJlcGVhdChsaW5lV2lkdGggKyAyKX0ke1xuICAgICAgICAgIHRoaXMudGhlbWUuY2hhcmFjdGVycy52YmFyX2JyZWFrXG4gICAgICAgIH0ke1wiIFwiLnJlcGVhdChsaW5lT2Zmc2V0KX0ke2luaXRpYWxIaWdobGlnaGVkTGluZS5qb2luKFwiXCIpfWBcbiAgICAgICk7XG5cbiAgICAgIC8vIGNvbnRpbnVlIGxvb3BpbmcgdW50aWwgd2UgaGF2ZSByZW5kZXJlZCBhbGwgdGhlIHNuaXBwZXRzXG4gICAgICB3aGlsZSAoc25pcHBldHNPbkxpbmVTb3J0ZWQubGVuZ3RoID4gMCkge1xuICAgICAgICBjb25zdCBsaW5lVG9SZW5kZXIgPSBBcnJheShsaW5lLmxlbmd0aCkuZmlsbChcIiBcIik7XG4gICAgICAgIHNuaXBwZXRzT25MaW5lU29ydGVkLmZvckVhY2goKHNuaXBwZXQsIGkpID0+IHtcbiAgICAgICAgICAvLyBJZiB3ZSBhcmUgdGhlIGxhc3Qgc25pcHBldCB0aGVuIHdlIGNhbiByZW5kZXIgb3V0IHRoZSBjb250ZXh0XG4gICAgICAgICAgaWYgKGkgPT09IHNuaXBwZXRzT25MaW5lU29ydGVkLmxlbmd0aCAtIDEpIHtcbiAgICAgICAgICAgIGxpbmVUb1JlbmRlci5zcGxpY2UoXG4gICAgICAgICAgICAgIHNuaXBwZXQub2Zmc2V0ICsgc25pcHBldC5jb250ZXh0Lmxlbmd0aCAvIDIsXG4gICAgICAgICAgICAgIDEsXG4gICAgICAgICAgICAgIFtcbiAgICAgICAgICAgICAgICBzbmlwcGV0LmNvbG9yKFxuICAgICAgICAgICAgICAgICAgdGhpcy50aGVtZS5jaGFyYWN0ZXJzLmxib3QgK1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnRoZW1lLmNoYXJhY3RlcnMudW5kZXJsaW5lLnJlcGVhdCgyKSArXG4gICAgICAgICAgICAgICAgICAgIFwiIFwiICtcbiAgICAgICAgICAgICAgICAgICAgc25pcHBldC5oaWdobGlnaHRcbiAgICAgICAgICAgICAgICApLFxuICAgICAgICAgICAgICBdXG4gICAgICAgICAgICApO1xuICAgICAgICAgICAgc25pcHBldHNPbkxpbmVTb3J0ZWQucG9wKCk7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGxpbmVUb1JlbmRlci5zcGxpY2UoXG4gICAgICAgICAgICAgIHNuaXBwZXQub2Zmc2V0ICsgc25pcHBldC5jb250ZXh0Lmxlbmd0aCAvIDIsXG4gICAgICAgICAgICAgIDEsXG4gICAgICAgICAgICAgIFtzbmlwcGV0LmNvbG9yKHRoaXMudGhlbWUuY2hhcmFjdGVycy52YmFyKV1cbiAgICAgICAgICAgICk7XG4gICAgICAgICAgfVxuICAgICAgICB9KTtcblxuICAgICAgICB0aGlzLndyaXRlTGluZShcbiAgICAgICAgICBgJHtcIiBcIi5yZXBlYXQobGluZVdpZHRoICsgMil9JHtcbiAgICAgICAgICAgIHRoaXMudGhlbWUuY2hhcmFjdGVycy52YmFyX2JyZWFrXG4gICAgICAgICAgfSR7XCIgXCIucmVwZWF0KGxpbmVPZmZzZXQpfSR7bGluZVRvUmVuZGVyLmpvaW4oXCJcIil9YFxuICAgICAgICApO1xuICAgICAgfVxuICAgIH0pO1xuXG4gICAgdGhpcy53cml0ZShcbiAgICAgIGAke1wiIFwiLnJlcGVhdChsaW5lV2lkdGggKyAyKX0ke1xuICAgICAgICB0aGlzLnRoZW1lLmNoYXJhY3RlcnMubGJvdFxuICAgICAgfSR7dGhpcy50aGVtZS5jaGFyYWN0ZXJzLmhiYXIucmVwZWF0KDMpfWBcbiAgICApO1xuICB9XG5cbiAgcmVuZGVyX2Zvb3RlcigpOiB2b2lkIHtcbiAgICBpZiAodGhpcy5kaWFnbm9zdGljLmhlbHApIHtcbiAgICAgIHRoaXMud3JpdGVMaW5lKFwiXCIpO1xuICAgICAgdGhpcy53cml0ZSh0aGlzLnRoZW1lLmNoYXJhY3RlcnMuZnlpICsgXCIgXCIpO1xuICAgICAgdGhpcy53cml0ZUxpbmUodGhpcy50aGVtZS5zdHlsZS5oZWxwKHRoaXMuZGlhZ25vc3RpYy5oZWxwKSk7XG4gICAgfVxuICAgIHRoaXMud3JpdGVMaW5lKFwiXCIpO1xuICB9XG59XG4iXX0=